# if (!requireNamespace("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")
# BiocManager::install("SNPlocs.Hsapiens.dbSNP151.GRCh38")
# if (!requireNamespace("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")
# BiocManager::install("SNPlocs.Hsapiens.dbSNP144.GRCh37")

library(TwoSampleMR)
library(dplyr)
library(googlesheets)
library(vcfR)
library(stringr)
library(mr.raps)
'%ni%' <- Negate('%in%')
# ieugwasr::api_status()
# $`API version`
# #3.6.7
# $`Total associations`
# [1] 126335269652
# $`Total complete datasets`
# [1] 34670
# $`Total public datasets`
# [1] 34513
library(MRInstruments)
library(MVMR)
library(SNPlocs.Hsapiens.dbSNP144.GRCh37)
library("SNPlocs.Hsapiens.dbSNP151.GRCh38")


ao <- available_outcomes()
# data(gwas_catalog)
# head(gwas_catalog)

Pathway_SNP="/scratch/ys98038/UKB/plink2_format/COVID_19/Analyses/SNP/"
Pathway_geno="/scratch/ys98038/UKB/plink2_format/COVID_19/Analyses/Genotype/"
Pathway_out="/scratch/ys98038/UKB/plink2_format/COVID_19/Analyses/MR_result/result_all_10_9/F_stat/"

Trait <- read.csv("/scratch/ys98038/UKB/plink2_format/COVID_19/Analyses/SNP/WBC_Trait.txt",header=F, as.is=T,sep = "\t")
Trait$V4=as.numeric(gsub(",", "", Trait$V4))

snps_38 <- SNPlocs.Hsapiens.dbSNP151.GRCh38
snps_37 <- SNPlocs.Hsapiens.dbSNP144.GRCh37
chr1_snps_37 <- snpsBySeqname(snps_37, "1")
SNPS_chr1_37=data.frame(chr1_snps_37@elementMetadata@listData$RefSNP_id,1,chr1_snps_37@ranges@pos,paste("1:",chr1_snps_37@ranges@pos,sep=""),paste("chr1:",chr1_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr1_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr2_snps_37 <- snpsBySeqname(snps_37, "2")
SNPS_chr2_37=data.frame(chr2_snps_37@elementMetadata@listData$RefSNP_id,2,chr2_snps_37@ranges@pos,paste("2:",chr2_snps_37@ranges@pos,sep=""),paste("chr2:",chr2_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr2_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr3_snps_37 <- snpsBySeqname(snps_37, "3")
SNPS_chr3_37=data.frame(chr3_snps_37@elementMetadata@listData$RefSNP_id,3,chr3_snps_37@ranges@pos,paste("3:",chr3_snps_37@ranges@pos,sep=""),paste("chr3:",chr3_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr3_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr4_snps_37 <- snpsBySeqname(snps_37, "4")
SNPS_chr4_37=data.frame(chr4_snps_37@elementMetadata@listData$RefSNP_id,4,chr4_snps_37@ranges@pos,paste("4:",chr4_snps_37@ranges@pos,sep=""),paste("chr4:",chr4_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr4_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr5_snps_37 <- snpsBySeqname(snps_37, "5")
SNPS_chr5_37=data.frame(chr5_snps_37@elementMetadata@listData$RefSNP_id,5,chr5_snps_37@ranges@pos,paste("5:",chr5_snps_37@ranges@pos,sep=""),paste("chr5:",chr5_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr5_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr6_snps_37 <- snpsBySeqname(snps_37, "6")
SNPS_chr6_37=data.frame(chr6_snps_37@elementMetadata@listData$RefSNP_id,6,chr6_snps_37@ranges@pos,paste("6:",chr6_snps_37@ranges@pos,sep=""),paste("chr6:",chr6_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr6_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr7_snps_37 <- snpsBySeqname(snps_37, "7")
SNPS_chr7_37=data.frame(chr7_snps_37@elementMetadata@listData$RefSNP_id,7,chr7_snps_37@ranges@pos,paste("7:",chr7_snps_37@ranges@pos,sep=""),paste("chr7:",chr7_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr7_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr8_snps_37 <- snpsBySeqname(snps_37, "8")
SNPS_chr8_37=data.frame(chr8_snps_37@elementMetadata@listData$RefSNP_id,8,chr8_snps_37@ranges@pos,paste("8:",chr8_snps_37@ranges@pos,sep=""),paste("chr8:",chr8_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr8_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr9_snps_37 <- snpsBySeqname(snps_37, "9")
SNPS_chr9_37=data.frame(chr9_snps_37@elementMetadata@listData$RefSNP_id,9,chr9_snps_37@ranges@pos,paste("9:",chr9_snps_37@ranges@pos,sep=""),paste("chr9:",chr9_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr9_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr10_snps_37 <- snpsBySeqname(snps_37, "10")
SNPS_chr10_37=data.frame(chr10_snps_37@elementMetadata@listData$RefSNP_id,10,chr10_snps_37@ranges@pos,paste("10:",chr10_snps_37@ranges@pos,sep=""),paste("chr10:",chr10_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr10_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr11_snps_37 <- snpsBySeqname(snps_37, "11")
SNPS_chr11_37=data.frame(chr11_snps_37@elementMetadata@listData$RefSNP_id,11,chr11_snps_37@ranges@pos,paste("11:",chr11_snps_37@ranges@pos,sep=""),paste("chr11:",chr11_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr11_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr12_snps_37 <- snpsBySeqname(snps_37, "12")
SNPS_chr12_37=data.frame(chr12_snps_37@elementMetadata@listData$RefSNP_id,12,chr12_snps_37@ranges@pos,paste("12:",chr12_snps_37@ranges@pos,sep=""),paste("chr12:",chr12_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr12_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr13_snps_37 <- snpsBySeqname(snps_37, "13")
SNPS_chr13_37=data.frame(chr13_snps_37@elementMetadata@listData$RefSNP_id,13,chr13_snps_37@ranges@pos,paste("13:",chr13_snps_37@ranges@pos,sep=""),paste("chr13:",chr13_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr13_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr14_snps_37 <- snpsBySeqname(snps_37, "14")
SNPS_chr14_37=data.frame(chr14_snps_37@elementMetadata@listData$RefSNP_id,14,chr14_snps_37@ranges@pos,paste("14:",chr14_snps_37@ranges@pos,sep=""),paste("chr14:",chr14_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr14_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr15_snps_37 <- snpsBySeqname(snps_37, "15")
SNPS_chr15_37=data.frame(chr15_snps_37@elementMetadata@listData$RefSNP_id,15,chr15_snps_37@ranges@pos,paste("15:",chr15_snps_37@ranges@pos,sep=""),paste("chr15:",chr15_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr15_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr16_snps_37 <- snpsBySeqname(snps_37, "16")
SNPS_chr16_37=data.frame(chr16_snps_37@elementMetadata@listData$RefSNP_id,16,chr16_snps_37@ranges@pos,paste("16:",chr16_snps_37@ranges@pos,sep=""),paste("chr16:",chr16_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr16_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr17_snps_37 <- snpsBySeqname(snps_37, "17")
SNPS_chr17_37=data.frame(chr17_snps_37@elementMetadata@listData$RefSNP_id,17,chr17_snps_37@ranges@pos,paste("17:",chr17_snps_37@ranges@pos,sep=""),paste("chr17:",chr17_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr17_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr18_snps_37 <- snpsBySeqname(snps_37, "18")
SNPS_chr18_37=data.frame(chr18_snps_37@elementMetadata@listData$RefSNP_id,18,chr18_snps_37@ranges@pos,paste("18:",chr18_snps_37@ranges@pos,sep=""),paste("chr18:",chr18_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr18_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr19_snps_37 <- snpsBySeqname(snps_37, "19")
SNPS_chr19_37=data.frame(chr19_snps_37@elementMetadata@listData$RefSNP_id,19,chr19_snps_37@ranges@pos,paste("19:",chr19_snps_37@ranges@pos,sep=""),paste("chr19:",chr19_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr19_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr20_snps_37 <- snpsBySeqname(snps_37, "20")
SNPS_chr20_37=data.frame(chr20_snps_37@elementMetadata@listData$RefSNP_id,20,chr20_snps_37@ranges@pos,paste("20:",chr20_snps_37@ranges@pos,sep=""),paste("chr20:",chr20_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr20_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr21_snps_37 <- snpsBySeqname(snps_37, "21")
SNPS_chr21_37=data.frame(chr21_snps_37@elementMetadata@listData$RefSNP_id,21,chr21_snps_37@ranges@pos,paste("21:",chr21_snps_37@ranges@pos,sep=""),paste("chr21:",chr21_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr21_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")
chr22_snps_37 <- snpsBySeqname(snps_37, "22")
SNPS_chr22_37=data.frame(chr22_snps_37@elementMetadata@listData$RefSNP_id,22,chr22_snps_37@ranges@pos,paste("22:",chr22_snps_37@ranges@pos,sep=""),paste("chr22:",chr22_snps_37@ranges@pos,sep=""))
colnames(SNPS_chr22_37) <- c("variant_id","chr_37","pos_37","location_37","location_chr_37")

SNPS_37=rbind(SNPS_chr1_37,SNPS_chr2_37,SNPS_chr3_37,SNPS_chr4_37,SNPS_chr5_37,SNPS_chr6_37,SNPS_chr7_37,SNPS_chr8_37,SNPS_chr9_37,SNPS_chr10_37,SNPS_chr11_37,SNPS_chr12_37,SNPS_chr13_37,SNPS_chr14_37,SNPS_chr15_37,SNPS_chr16_37,SNPS_chr17_37,SNPS_chr18_37,SNPS_chr19_37,SNPS_chr20_37,SNPS_chr21_37,SNPS_chr22_37)

chr1_snps_38 <- snpsBySeqname(snps_38, "1")
SNPS_chr1_38=data.frame(chr1_snps_38@elementMetadata@listData$RefSNP_id,1,chr1_snps_38@ranges@pos,paste("1:",chr1_snps_38@ranges@pos,sep=""),paste("chr1:",chr1_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr1_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr2_snps_38 <- snpsBySeqname(snps_38, "2")
SNPS_chr2_38=data.frame(chr2_snps_38@elementMetadata@listData$RefSNP_id,2,chr2_snps_38@ranges@pos,paste("2:",chr2_snps_38@ranges@pos,sep=""),paste("chr2:",chr2_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr2_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr3_snps_38 <- snpsBySeqname(snps_38, "3")
SNPS_chr3_38=data.frame(chr3_snps_38@elementMetadata@listData$RefSNP_id,3,chr3_snps_38@ranges@pos,paste("3:",chr3_snps_38@ranges@pos,sep=""),paste("chr3:",chr3_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr3_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr4_snps_38 <- snpsBySeqname(snps_38, "4")
SNPS_chr4_38=data.frame(chr4_snps_38@elementMetadata@listData$RefSNP_id,4,chr4_snps_38@ranges@pos,paste("4:",chr4_snps_38@ranges@pos,sep=""),paste("chr4:",chr4_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr4_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr5_snps_38 <- snpsBySeqname(snps_38, "5")
SNPS_chr5_38=data.frame(chr5_snps_38@elementMetadata@listData$RefSNP_id,5,chr5_snps_38@ranges@pos,paste("5:",chr5_snps_38@ranges@pos,sep=""),paste("chr5:",chr5_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr5_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr6_snps_38 <- snpsBySeqname(snps_38, "6")
SNPS_chr6_38=data.frame(chr6_snps_38@elementMetadata@listData$RefSNP_id,6,chr6_snps_38@ranges@pos,paste("6:",chr6_snps_38@ranges@pos,sep=""),paste("chr6:",chr6_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr6_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr7_snps_38 <- snpsBySeqname(snps_38, "7")
SNPS_chr7_38=data.frame(chr7_snps_38@elementMetadata@listData$RefSNP_id,7,chr7_snps_38@ranges@pos,paste("7:",chr7_snps_38@ranges@pos,sep=""),paste("chr7:",chr7_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr7_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr8_snps_38 <- snpsBySeqname(snps_38, "8")
SNPS_chr8_38=data.frame(chr8_snps_38@elementMetadata@listData$RefSNP_id,8,chr8_snps_38@ranges@pos,paste("8:",chr8_snps_38@ranges@pos,sep=""),paste("chr8:",chr8_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr8_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr9_snps_38 <- snpsBySeqname(snps_38, "9")
SNPS_chr9_38=data.frame(chr9_snps_38@elementMetadata@listData$RefSNP_id,9,chr9_snps_38@ranges@pos,paste("9:",chr9_snps_38@ranges@pos,sep=""),paste("chr9:",chr9_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr9_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr10_snps_38 <- snpsBySeqname(snps_38, "10")
SNPS_chr10_38=data.frame(chr10_snps_38@elementMetadata@listData$RefSNP_id,10,chr10_snps_38@ranges@pos,paste("10:",chr10_snps_38@ranges@pos,sep=""),paste("chr10:",chr10_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr10_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr11_snps_38 <- snpsBySeqname(snps_38, "11")
SNPS_chr11_38=data.frame(chr11_snps_38@elementMetadata@listData$RefSNP_id,11,chr11_snps_38@ranges@pos,paste("11:",chr11_snps_38@ranges@pos,sep=""),paste("chr11:",chr11_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr11_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr12_snps_38 <- snpsBySeqname(snps_38, "12")
SNPS_chr12_38=data.frame(chr12_snps_38@elementMetadata@listData$RefSNP_id,12,chr12_snps_38@ranges@pos,paste("12:",chr12_snps_38@ranges@pos,sep=""),paste("chr12:",chr12_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr12_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr13_snps_38 <- snpsBySeqname(snps_38, "13")
SNPS_chr13_38=data.frame(chr13_snps_38@elementMetadata@listData$RefSNP_id,13,chr13_snps_38@ranges@pos,paste("13:",chr13_snps_38@ranges@pos,sep=""),paste("chr13:",chr13_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr13_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr14_snps_38 <- snpsBySeqname(snps_38, "14")
SNPS_chr14_38=data.frame(chr14_snps_38@elementMetadata@listData$RefSNP_id,14,chr14_snps_38@ranges@pos,paste("14:",chr14_snps_38@ranges@pos,sep=""),paste("chr14:",chr14_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr14_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr15_snps_38 <- snpsBySeqname(snps_38, "15")
SNPS_chr15_38=data.frame(chr15_snps_38@elementMetadata@listData$RefSNP_id,15,chr15_snps_38@ranges@pos,paste("15:",chr15_snps_38@ranges@pos,sep=""),paste("chr15:",chr15_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr15_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr16_snps_38 <- snpsBySeqname(snps_38, "16")
SNPS_chr16_38=data.frame(chr16_snps_38@elementMetadata@listData$RefSNP_id,16,chr16_snps_38@ranges@pos,paste("16:",chr16_snps_38@ranges@pos,sep=""),paste("chr16:",chr16_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr16_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr17_snps_38 <- snpsBySeqname(snps_38, "17")
SNPS_chr17_38=data.frame(chr17_snps_38@elementMetadata@listData$RefSNP_id,17,chr17_snps_38@ranges@pos,paste("17:",chr17_snps_38@ranges@pos,sep=""),paste("chr17:",chr17_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr17_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr18_snps_38 <- snpsBySeqname(snps_38, "18")
SNPS_chr18_38=data.frame(chr18_snps_38@elementMetadata@listData$RefSNP_id,18,chr18_snps_38@ranges@pos,paste("18:",chr18_snps_38@ranges@pos,sep=""),paste("chr18:",chr18_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr18_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr19_snps_38 <- snpsBySeqname(snps_38, "19")
SNPS_chr19_38=data.frame(chr19_snps_38@elementMetadata@listData$RefSNP_id,19,chr19_snps_38@ranges@pos,paste("19:",chr19_snps_38@ranges@pos,sep=""),paste("chr19:",chr19_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr19_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr20_snps_38 <- snpsBySeqname(snps_38, "20")
SNPS_chr20_38=data.frame(chr20_snps_38@elementMetadata@listData$RefSNP_id,20,chr20_snps_38@ranges@pos,paste("20:",chr20_snps_38@ranges@pos,sep=""),paste("chr20:",chr20_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr20_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr21_snps_38 <- snpsBySeqname(snps_38, "21")
SNPS_chr21_38=data.frame(chr21_snps_38@elementMetadata@listData$RefSNP_id,21,chr21_snps_38@ranges@pos,paste("21:",chr21_snps_38@ranges@pos,sep=""),paste("chr21:",chr21_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr21_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")
chr22_snps_38 <- snpsBySeqname(snps_38, "22")
SNPS_chr22_38=data.frame(chr22_snps_38@elementMetadata@listData$RefSNP_id,22,chr22_snps_38@ranges@pos,paste("22:",chr22_snps_38@ranges@pos,sep=""),paste("chr22:",chr22_snps_38@ranges@pos,sep=""))
colnames(SNPS_chr22_38) <- c("variant_id","chr_38","pos_38","location_38","location_chr_38")

SNPS_38=rbind(SNPS_chr1_38,SNPS_chr2_38,SNPS_chr3_38,SNPS_chr4_38,SNPS_chr5_38,SNPS_chr6_38,SNPS_chr7_38,SNPS_chr8_38,SNPS_chr9_38,SNPS_chr10_38,SNPS_chr11_38,SNPS_chr12_38,SNPS_chr13_38,SNPS_chr14_38,SNPS_chr15_38,SNPS_chr16_38,SNPS_chr17_38,SNPS_chr18_38,SNPS_chr19_38,SNPS_chr20_38,SNPS_chr21_38,SNPS_chr22_38)

save(SNPS_37,file = "/scratch/ys98038/UKB/plink2_format/COVID_19/Analyses/SNP/SNPS_37.RData")
save(SNPS_38,file = "/scratch/ys98038/UKB/plink2_format/COVID_19/Analyses/SNP/SNPS_38.RData")

SNPS_37_38 <- SNPS_37 %>% inner_join(SNPS_38, by= "variant_id")
save(SNPS_37_38,file = "/scratch/ys98038/UKB/plink2_format/COVID_19/Analyses/SNP/SNPS_37_38.RData")
write.table(SNPS_37_38, file= "/scratch/ys98038/UKB/plink2_format/COVID_19/Analyses/SNP/SNPS_37_38.txt", col.names = TRUE, append = TRUE, row.names = FALSE, quote = FALSE, sep='\t')
